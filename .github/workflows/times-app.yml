name: Build and Publish WAR to Artifactory

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WAR
        run: mvn -B clean package

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v2

      - name: Configure & Upload to Artifactory
        # pass secrets into the shell environment (they will be masked in logs)
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
          JFROG_REPO: ${{ secrets.JFROG_REPO }}
        run: |
          # fail fast with a human-friendly message if any required secret is missing
          if [ -z "$JFROG_URL" ] || [ -z "$JFROG_USERNAME" ] || [ -z "$JFROG_PASSWORD" ] || [ -z "$JFROG_REPO" ]; then
            echo "ERROR: Missing one or more Artifactory secrets. Please set JFROG_URL, JFROG_USERNAME, JFROG_PASSWORD, JFROG_REPO in repository secrets."
            exit 1
          fi

          # configure jfrog cli (non-interactive)
          jfrog config add artifactory --interactive=false \
            --url="$JFROG_URL" \
            --user="$JFROG_USERNAME" \
            --password="$JFROG_PASSWORD"

          # upload the built WAR
          jfrog rt u "target/*.war" "${JFROG_REPO}/" --flat=true
