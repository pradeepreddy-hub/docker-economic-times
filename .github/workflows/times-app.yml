name: Build and Publish WAR to Artifactory

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build WAR
        run: mvn -B clean package -DskipTests

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v2

      - name: Configure and upload to Artifactory (safe)
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_PASSWORD: ${{ secrets.JFROG_PASSWORD }}
          JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
          JFROG_REPO: ${{ secrets.JFROG_REPO }}
        run: |
          set -euo pipefail

          # Basic validation
          if [ -z "${JFROG_URL:-}" ] || [ -z "${JFROG_REPO:-}" ]; then
            echo "ERROR: JFROG_URL and JFROG_REPO must be set as repository secrets."
            exit 1
          fi

          echo "Pinging Artifactory at $JFROG_URL ..."
          if ! curl -sSf --connect-timeout 10 "$JFROG_URL/api/system/ping" >/dev/null; then
            echo "ERROR: Unable to reach $JFROG_URL (ping failed). Check JFROG_URL format."
            exit 1
          fi

          # Configure JFrog CLI: prefer access token
          if [ -n "${JFROG_ACCESS_TOKEN:-}" ]; then
            echo "Using JFROG_ACCESS_TOKEN for authentication."
            jfrog config add artifactory --interactive=false --url="$JFROG_URL" --access-token="$JFROG_ACCESS_TOKEN"
          else
            if [ -z "${JFROG_USERNAME:-}" ] || [ -z "${JFROG_PASSWORD:-}" ]; then
              echo "ERROR: No access token and username/password not fully provided."
              echo "Set JFROG_ACCESS_TOKEN or both JFROG_USERNAME and JFROG_PASSWORD in repo secrets."
              exit 1
            fi
            echo "Using JFROG_USERNAME/JFROG_PASSWORD for authentication."
            jfrog config add artifactory --interactive=false --url="$JFROG_URL" --user="$JFROG_USERNAME" --password="$JFROG_PASSWORD"
          fi

          # Verify artifact exists
          ARTIFACT_GLOB="target/*.war"
          if ! ls $ARTIFACT_GLOB >/dev/null 2>&1; then
            echo "ERROR: No WAR found at $ARTIFACT_GLOB. Check your build output."
            exit 1
          fi

          echo "Uploading $ARTIFACT_GLOB -> ${JFROG_REPO}/"
          jfrog rt u "$ARTIFACT_GLOB" "${JFROG_REPO}/" --flat=true

          echo "Upload finished."
